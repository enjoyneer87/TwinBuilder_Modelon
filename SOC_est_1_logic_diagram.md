# SOC_est_1.mo 로직 다이어그램
# 배터리 SOC 추정기 (State of Charge Estimator)

## 전체 로직 흐름도

```
┌─────────────────┐
│   입력 전류 I   │
│   [A]          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   signGain      │  ◄── dischargePositive 파라미터에 따라
│   전류 방향 변환 │     k = 1 (방전+) 또는 k = -1 (충전+)
└─────────┬───────┘
          │
          ├─────────────────┬─────────────────┐
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   prodDis       │ │   geZero        │ │   prodChg       │
│   방전 효율 적용│ │   I >= 0 판별  │ │   충전 효율 적용│
│   I * (1/eta_dis)│ │                 │ │   I * eta_chg   │
└─────────┬───────┘ └─────────┬───────┘ └─────────┬───────┘
          │                   │                   │
          └─────────┬─────────┼─────────┬─────────┘
                    │         │         │
                    ▼         ▼         ▼
          ┌─────────────────┐         │
          │   pickIeff      │ ◄───────┘
          │   유효 전류 선택│
          │   (방전/충전)   │
          └─────────┬───────┘
                    │
                    ▼
          ┌─────────────────┐
          │   kGain         │
          │   SOC 변화율 변환│
          │   -I_eff / C_rated│
          └─────────┬───────┘
                    │
                    ▼
          ┌─────────────────┐
          │   integ         │
          │   SOC 적분      │
          │   초기값: SOC0  │
          └─────────┬───────┘
                    │
                    ▼
          ┌─────────────────┐
          │   limiter       │
          │   SOC 범위 제한 │
          │   0 ≤ SOC ≤ 1   │
          └─────────┬───────┘
                    │
                    ▼
          ┌─────────────────┐
          │   SOC_est 출력 │
          │   [0..1]       │
          └─────────────────┘
```

## 상세 로직 설명

### 1. 전류 방향 변환 (signGain)
```
dischargePositive = true  → k = +1  (I>0 = 방전)
dischargePositive = false → k = -1  (I>0 = 충전)
```

### 2. 효율 적용
```
방전 시: I_eff = I * (1/eta_dis)  // 효율 손실 보정
충전 시: I_eff = I * eta_chg       // 효율 손실 보정
```

### 3. 모드 판별 및 전류 선택
```
if (I >= 0) {
    I_eff = prodDis.y  // 방전 모드
} else {
    I_eff = prodChg.y  // 충전 모드
}
```

### 4. SOC 변화율 계산
```
dSOC/dt = -I_eff / C_rated
```

### 5. SOC 적분
```
SOC(t) = SOC0 + ∫(dSOC/dt) dt
```

### 6. 범위 제한
```
SOC_final = max(0, min(1, SOC(t)))
```

## 주요 파라미터 설명

| 파라미터 | 설명 | 기본값 |
|----------|------|--------|
| SOC0 | 초기 SOC (0-1) | 0.8 |
| C_rated | 정격 용량 [C] | 200*3600 |
| dischargePositive | I>0=방전 설정 | true |
| eta_chg | 충전 효율 | 0.99 |
| eta_dis | 방전 효율 | 1.00 |

## 블록 연결 관계

```
I → signGain → prodDis → pickIeff → kGain → integ → limiter → SOC_est
       │          │         │
       │          │         │
       └─────────► geZero ──┘
       │
       └─────────► prodChg ──┘
```

이 로직은 쿨롱 계수법(Coulomb Counting)을 기반으로 하며,
배터리의 충전 상태를 실시간으로 추정합니다.
